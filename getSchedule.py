#!/usr/bin/env python

import json, requests
from bs4 import BeautifulSoup

def getRides(stop):
	# Viewstate. May be fine to hardcode value, or may have to be refreshed each time / each day, by essentially running an extra page request and parse for this specific value.
	viewstate = '/wEPDwUKLTUyNjEwNDI1NQ9kFgJmD2QWAgIDD2QWBGYPDxYCHgRUZXh0BSNCcmFtcHRvbiBUcmFuc2l0IE5leHQgUmlkZSAtIE1vYmlsZWRkAgMPZBYIAgMPZBYEAgEPZBYCAgEPZBYCAgEPZBYGAgMPEGRkFgBkAgUPFgIeB1Zpc2libGVoFgQCAQ8WAh8BaGQCAw8QDxYCHwFoZBAVARctLS0gU2hvdyBBbGwgUm91dGVzIC0tLRUBATAUKwMBZxYBZmQCBw8PFgIfAGVkZAICD2QWAgIBD2QWAgIBD2QWBgIBDxAPFggeDERhdGFTb3VyY2VJRGUeDURhdGFUZXh0RmllbGQFBlJvdXRlTh4ORGF0YVZhbHVlRmllbGQFBlJvdXRlSR4LXyFEYXRhQm91bmRnZBAVdBYtLS0gU2VsZWN0IEEgUm91dGUgLS0tDzEgLSBRdWVlbiwgV2VzdA8xIC0gUXVlZW4sIEVhc3QPMiAtIE1haW4sIFNvdXRoDzIgLSBNYWluLCBOb3J0aBUzIC0gTWNMYXVnaGxpbiwgU291dGgVMyAtIE1jTGF1Z2hsaW4sIE5vcnRoFzQgLSBDaGluZ3VhY291c3ksIFNvdXRoFzQgLSBDaGluZ3VhY291c3ksIE5vcnRoETUgLSBCb3ZhaXJkLCBXZXN0ETUgLSBCb3ZhaXJkLCBFYXN0EjcgLSBLZW5uZWR5LCBTb3V0aBI3IC0gS2VubmVkeSwgTm9ydGgQOCAtIENlbnRyZSwgV2VzdBA4IC0gQ2VudHJlLCBFYXN0EDkgLSBWb2RkZW4sIFdlc3QQOSAtIFZvZGRlbiwgRWFzdBwxMCAtIFNvdXRoIEluZHVzdHJpYWwsIFNvdXRoHDEwIC0gU291dGggSW5kdXN0cmlhbCwgTm9ydGgSMTEgLSBTdGVlbGVzLCBXZXN0EjExIC0gU3RlZWxlcywgRWFzdBQxMiAtIEdyZW5vYmxlLCBTb3V0aBQxMiAtIEdyZW5vYmxlLCBOb3J0aBQxMyAtIEF2b25kYWxlLCBTb3V0aBQxMyAtIEF2b25kYWxlLCBOb3J0aBMxNCAtIFRvcmJyYW0sIFNvdXRoEzE0IC0gVG9yYnJhbSwgTm9ydGgUMTUgLSBCcmFtYWxlYSwgU291dGgUMTUgLSBCcmFtYWxlYSwgTm9ydGgVMTYgLSBTb3V0aGdhdGUsIFNvdXRoFTE2IC0gU291dGhnYXRlLCBOb3J0aBIxNyAtIEhvd2RlbiwgU291dGgSMTcgLSBIb3dkZW4sIE5vcnRoETE4IC0gRGl4aWUsIFNvdXRoETE4IC0gRGl4aWUsIE5vcnRoFjE5IC0gRmVybmZvcmVzdCwgU291dGgWMTkgLSBGZXJuZm9yZXN0LCBOb3J0aBoyMCAtIEVhc3QgSW5kdXN0cmlhbCwgV2VzdBoyMCAtIEVhc3QgSW5kdXN0cmlhbCwgRWFzdBYyMSAtIEhlYXJ0IExha2UsIFNvdXRoFjIxIC0gSGVhcnQgTGFrZSwgTm9ydGgVMjMgLSBTYW5kYWx3b29kLCBXZXN0FTIzIC0gU2FuZGFsd29vZCwgRWFzdBQyNCAtIFZhbiBLaXJrLCBTb3V0aBQyNCAtIFZhbiBLaXJrLCBOb3J0aBUyNSAtIEVkZW5icm9vaywgU291dGgVMjUgLSBFZGVuYnJvb2ssIE5vcnRoHjI2IC0gTW91bnQgUGxlYXNhbnQsIENsb2Nrd2lzZRMyOSAtIFdpbGxpYW1zLCBXZXN0EzI5IC0gV2lsbGlhbXMsIEVhc3QYMzAgLSBBaXJwb3J0IFJvYWQsIFNvdXRoGDMwIC0gQWlycG9ydCBSb2FkLCBOb3J0aBIzMSAtIE1jVmVhbiwgU291dGgSMzEgLSBNY1ZlYW4sIE5vcnRoHDMyIC0gRmF0aGVyIFRvYmluLCBDbG9ja3dpc2UmMzMgLSBQZXRlciBSb2JlcnRzb24sIENvdW50ZXJDbG9ja3dpc2UUMzUgLSBDbGFya3dheSwgU291dGgUMzUgLSBDbGFya3dheSwgTm9ydGgeNDAgLSBDZW50cmFsIEluZHVzdHJpYWwsIFNvdXRoHjQwIC0gQ2VudHJhbCBJbmR1c3RyaWFsLCBOb3J0aBU1MCAtIEdvcmUgUm9hZCwgU291dGgVNTAgLSBHb3JlIFJvYWQsIE5vcnRoFzUxIC0gU3RlZWxlcyBXZXN0LCBXZXN0FzUxIC0gU3RlZWxlcyBXZXN0LCBFYXN0FDUyIC0gTWNNdXJjaHksIFNvdXRoFDUyIC0gTWNNdXJjaHksIE5vcnRoFjUzIC0gT2FrbGVhLCBDbG9ja3dpc2UjNTQgLSBKYW1lcyBQb3R0ZXIsIENvdW50ZXJDbG9ja3dpc2UXNTYgLSBTcHJpbmdicm9vaywgU291dGgXNTYgLSBTcHJpbmdicm9vaywgTm9ydGggNTggLSBGaW5hbmNpYWwsIENvdW50ZXJDbG9ja3dpc2UZNjUgLSBTZW5pb3IgU2hvcHBlciwgRGlyMhk2NSAtIFNlbmlvciBTaG9wcGVyLCBEaXIxHzkyIC0gQnJhbWFsZWEgR08gU2h1dHRsZSwgU291dGgfOTIgLSBCcmFtYWxlYSBHTyBTaHV0dGxlLCBOb3J0aCQxMTUgLSBQZWFyc29uIEFpcnBvcnQgRXhwcmVzcywgU291dGgkMTE1IC0gUGVhcnNvbiBBaXJwb3J0IEV4cHJlc3MsIE5vcnRoJjIwMCAtIFR1cm5lciBGZW50b24gU2Nob29sIFJvdXRlLCBXZXN0JjIwMCAtIFR1cm5lciBGZW50b24gU2Nob29sIFJvdXRlLCBFYXN0ITIwMSAtIE1heWZpZWxkIFNjaG9vbCBSb3V0ZSwgV2VzdCEyMDEgLSBNYXlmaWVsZCBTY2hvb2wgUm91dGUsIEVhc3QhMjAyIC0gTWF5ZmllbGQgU2Nob29sIFJvdXRlLCBXZXN0ITIwMiAtIE1heWZpZWxkIFNjaG9vbCBSb3V0ZSwgRWFzdCEyMDMgLSBNYXlmaWVsZCBTY2hvb2wgUm91dGUsIFdlc3QhMjA0IC0gTWF5ZmllbGQgU2Nob29sIFJvdXRlLCBXZXN0KTIwNSAtIFN0LiBUaG9tYXMgQXF1aW5hcyBTY2hvb2wgUm91LCBXZXN0KTIwNSAtIFN0LiBUaG9tYXMgQXF1aW5hcyBTY2hvb2wgUm91LCBFYXN0JzIwNiAtIFN0LiBBdWd1c3RpbmUgU2Nob29sIFJvdXRlLCBTb3V0aCcyMDYgLSBTdC4gQXVndXN0aW5lIFNjaG9vbCBSb3V0ZSwgTm9ydGgiMjA3IC0gTWF5ZmllbGQgU2Nob29sIFJvdXRlLCBTb3V0aCIyMDcgLSBNYXlmaWVsZCBTY2hvb2wgUm91dGUsIE5vcnRoIjIwOCAtIE1heWZpZWxkIFNjaG9vbCBSb3V0ZSwgU291dGgiMjA4IC0gTWF5ZmllbGQgU2Nob29sIFJvdXRlLCBOb3J0aCcyMDkgLSBTdC4gQXVndXN0aW5lIFNjaG9vbCBS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'
	payload = { '__VIEWSTATE': viewstate, 'ctl00$mainPanel$searchbyStop$txtStop': stop, 'ctl00$mainPanel$btnGetRealtimeSchedule': 'GO' }
	r = requests.post('http://nextride.brampton.ca/mob/SearchBy.aspx', data=payload)
	return r

def parseSchedule(response):
	soup = BeautifulSoup(response.text)
	schedule = None
	if soup.find(id="ctl00_mainPanel_lblError"):
		schedule = None
	else:
		if soup.find(id="ctl00_mainPanel_lblStopDescription"):
			stopDesc = soup.find(id="ctl00_mainPanel_lblStopDescription")
			stopID = stopDesc.string.split(', ',1)[0].replace('Stop ','')
			stopName = stopDesc.string.split(', ',1)[1].replace(' at ',' / ')
		if soup.find(id="ctl00_mainPanel_gvSearchResult"):
			buses = soup.find(id="ctl00_mainPanel_gvSearchResult").find_all('tr')
			schedule = { 'stopID': stopID, 'stopName': stopName }
			if buses[1].td.string == 'No Service':
				schedule.update(routes=None)
			else:
				routes = []
				for bus in buses[1:]:
					route = bus.td.string.split(' to ',1)
					time = bus.td.next_sibling.string
					routes.append({ 'route': route[0].replace('Route ',''), 'direction': route[1], 'time': time })
				schedule.update(routes=routes)
	return schedule

if __name__=="__main__":
	stop = '2000'
	schedule = parseSchedule(getRides(stop))
	print json.dumps(schedule, indent=4)
